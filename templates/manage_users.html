{% extends "base.html" %}

{% block title %}Управление пользователями{% endblock %}
{% block header %}Управление пользователями{% endblock %}

{% block content %}
<h1>Управление пользователями</h1>
<p class="text-muted">Просмотр и редактирование пользователей. Нажмите "Редактировать" для изменения всех данных пользователя (кроме пароля).</p>

<div class="table-responsive">
  <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th>ID</th>
        <th>ФИО</th>
        <th>Телефон</th>
        <th>Логин</th>
        <th>Роль</th>
        <th>Статус</th>
        <th>Дата регистрации</th>
        <th>Действия</th>
      </tr>
    </thead>
    <tbody>
      {% for u in users %}
      <tr>
        <td>{{ u.user_id }}</td>
        <td>{{ u.fio }}</td>
        <td>{% if u.phone %}{{ u.phone }}{% else %}<span class="text-muted">Не указан</span>{% endif %}</td>
        <td>{{ u.login }}</td>
        <td>
          <span class="badge bg-info">{{ u.user_type }}</span>
        </td>
        <td>
          {% if u.is_active %}
          <span class="badge bg-success">Активен</span>
          {% else %}
          <span class="badge bg-danger">Неактивен</span>
          {% endif %}
        </td>
        <td>{{ u.registration_date or '-' }}</td>
        <td>
          <button type="button" class="btn btn-sm btn-outline-primary" 
                  data-bs-toggle="modal" 
                  data-bs-target="#editUserModal{{ u.user_id }}">
            ✏️ Редактировать
          </button>
        </td>
      </tr>
      
      <!-- Модальное окно для редактирования пользователя -->
      <div class="modal fade" id="editUserModal{{ u.user_id }}" tabindex="-1" aria-labelledby="editUserModalLabel{{ u.user_id }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editUserModalLabel{{ u.user_id }}">Редактирование пользователя: {{ u.fio }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{{ url_for('manage_users') }}" novalidate>
              <div class="modal-body">
                <input type="hidden" name="action" value="edit_user">
                <input type="hidden" name="user_id" value="{{ u.user_id }}">
                
                <div class="mb-3">
                  <label class="form-label">ФИО <span class="text-danger">*</span></label>
                  <input type="text" name="fio" class="form-control" value="{{ u.fio }}" required>
                </div>
                
                <div class="mb-3">
                  <label class="form-label">Телефон</label>
                  <input type="text" name="phone" class="form-control" value="{{ u.phone or '' }}" placeholder="Необязательно">
                  <div class="form-text">Оставьте пустым, если не нужно указывать телефон</div>
                </div>
                
                <div class="mb-3">
                  <label class="form-label">Логин <span class="text-danger">*</span></label>
                  <input type="text" name="login" class="form-control" value="{{ u.login }}" required>
                  <div class="form-text">Логин должен быть уникальным</div>
                </div>
                
                <div class="mb-3">
                  <label class="form-label">Роль <span class="text-danger">*</span></label>
                  <select name="user_type" class="form-select" required>
                    {% for role in roles %}
                    <option value="{{ role }}" {% if role == u.user_type %}selected{% endif %}>
                      {{ role }}
                    </option>
                    {% endfor %}
                  </select>
                </div>
                
                <div class="mb-3">
                  <label class="form-label">Статус активности</label>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" name="is_active" value="1" 
                           id="isActive{{ u.user_id }}" {% if u.is_active %}checked{% endif %}>
                    <label class="form-check-label" for="isActive{{ u.user_id }}">
                      {% if u.is_active %}Пользователь активен{% else %}Пользователь неактивен{% endif %}
                    </label>
                  </div>
                </div>
                
                <div class="alert alert-info">
                  <strong>Примечание:</strong> Пароль пользователя нельзя изменить через эту форму.
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="submit" class="btn btn-primary">Сохранить изменения</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}
    </tbody>
  </table>
</div>

<a href="{{ url_for('requests_list') }}" class="btn btn-secondary">Назад к заявкам</a>
{% endblock %}
