ОПИСАНИЕ БАЗЫ ДАННЫХ И РОЛЕЙ ПОЛЬЗОВАТЕЛЕЙ
=========================================

1. Описание ER‑диаграммы
------------------------

В системе учёта заявок на ремонт климатического оборудования используются следующие основные сущности:

1. Пользователи (users)
   - Представляют всех участников процесса: заказчиков, специалистов, операторов, менеджеров, менеджеров по качеству и администраторов.
   - Основные поля: идентификатор, ФИО, телефон, логин, пароль, роль (user_type), признак активности, дата регистрации и дополнительные контактные данные.

2. Заявки (requests)
   - Описывают обращения клиентов по ремонту климатического оборудования.
   - Основные поля: идентификатор, номер заявки, даты начала и завершения, тип и модель оборудования, описание проблемы, статус заявки, приоритет, ссылки на заказчика, специалиста и менеджера по качеству, а также служебные поля (история обновлений, флаги о наличии отзыва и др.).
   - Внешние ключи:
     - client_id → users.user_id (заказчик);
     - master_id → users.user_id (исполнитель);
     - quality_manager_id → users.user_id (менеджер по качеству).

3. Комментарии (comments)
   - Хранят текстовые комментарии по заявкам от пользователей.
   - Содержат ссылку на заявку (request_id) и пользователя (user_id), текст сообщения и дату создания.

4. Отзывы (reviews)
   - Содержат оценку качества выполненной работы по каждой заявке.
   - Поля: ссылка на заявку, числовой рейтинг, текст отзыва, дата отзыва и дополнительные сведения.

5. Комплектующие (spare_parts) и использование деталей в заявках (request_parts)
   - Справочник комплектующих: код детали, наименование, описание, производитель, остаток на складе, цена и т.п.
   - Таблица request_parts связывает конкретные заявки и детали, фиксирует требуемое и фактическое количество, статусы поставки и заметки.

6. История статусов (request_history)
   - Фиксирует изменения статуса каждой заявки.
   - Поля: ссылка на заявку, старый и новый статус, идентификатор пользователя, выполнившего изменение, дата и причина.

7. Специализации (specializations)
   - Описывают области компетенций специалистов.
   - Поля: ссылка на пользователя, тип оборудования, уровень навыка, дата сертификации.

8. Уведомления (notifications)
   - Служат для отправки системных сообщений пользователям (например, о низком остатке комплектующих).
   - Поля: ссылка на пользователя, заголовок, текст сообщения, тип уведомления, признак прочтения, ссылка на связанную заявку, дата создания.

Все связи между сущностями, а также первичные и внешние ключи отражены в ER‑диаграмме (файлы Er.svg и er_diagram.mmd).


2. Нормализация до третьей нормальной формы
-------------------------------------------

База данных спроектирована в соответствии с требованиями 3‑й нормальной формы:

- Каждая таблица описывает одну логическую сущность или одно отношение (например, users, requests, request_parts).
- Все неключевые атрибуты зависят только от первичного ключа таблицы (нет частичных зависимостей от части составного ключа).
- Отсутствуют транзитивные зависимости между неключевыми атрибутами: справочная информация и связующие таблицы вынесены в отдельные сущности (например, детали и их использование в заявках).
- Внешние ключи и ограничения обеспечивают ссылочную целостность и согласованность данных:
  - при удалении записи в заявках связанные данные об истории и комментариях удаляются каскадно;
  - при изменении связей с пользователями используются соответствующие действия (SET NULL или CASCADE) в зависимости от логики предметной области.

Таким образом, структура базы данных удовлетворяет требованиям 3НФ и предотвращает аномалии вставки, обновления и удаления.


3. Роли пользователей и уровни доступа
--------------------------------------

В системе определены следующие роли пользователей:

1. Администратор
   - Техническая роль с полным доступом к данным и настройкам системы.
   - Может просматривать и изменять все заявки, пользователей, справочники и настройки.
   - В учебном проекте роль зарезервирована; фактические административные функции выполняет менеджер.

2. Менеджер
   - Основная административная роль в системе.
   - Полномочия:
     - просмотр и редактирование всех заявок;
     - назначение и смена специалистов и клиентов в заявках;
     - управление пользователями (изменение роли, блокировка/разблокировка учётных записей);
     - создание новых заказчиков.

3. Менеджер по качеству
   - Имеет расширенные права по работе с заявками, аналогичные правам менеджера.
   - Полномочия:
     - анализ сложных заявок и консультирование специалистов;
     - участие в продлении сроков выполнения заявок по согласованию с заказчиком;
     - использование отзывов и статистики для оценки качества работы.

4. Оператор
   - Регистратор заявок и диспетчер.
   - Полномочия:
     - создание новых заявок;
     - редактирование основных полей заявок и смена статуса;
     - назначение специалистов;
     - работа со списком заявок и их фильтрация.

5. Специалист
   - Исполнитель работ по заявкам.
   - Полномочия:
     - просмотр заявок, в которых он назначен исполнителем;
     - изменение статуса таких заявок;
     - добавление комментариев и информации о ходе ремонта и используемых комплектующих.

6. Заказчик
   - Клиент сервиса.
   - Полномочия:
     - регистрация в системе;
     - создание новых заявок только на себя;
     - просмотр своих заявок;
     - ограниченное редактирование своих заявок (дата и описание проблемы) до определённого этапа обработки.


4. Принцип разграничения доступа
--------------------------------

- Все пользователи проходят аутентификацию по логину и паролю.
- Данные о пользователе (идентификатор, ФИО, роль) сохраняются в сессии.
- Доступ к основным страницам защищён декоратором login_required.
- Для управления пользователями используется дополнительная проверка роли (менеджер).
- Права на редактирование конкретной заявки вычисляются функцией can_edit_request на основе:
  - роли пользователя;
  - идентификатора пользователя;
  - связи пользователя с заявкой (заказчик, специалист или управляющая роль).
- Заказчики видят и редактируют только свои заявки, тогда как управляющие роли (менеджер, менеджер по качеству, администратор) могут работать со всеми заявками.


