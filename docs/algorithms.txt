АЛГОРИТМЫ РАБОТЫ МОДУЛЯ
=======================

1. Общий алгоритм учёта заявок (текстовое описание)
---------------------------------------------------

1. Запуск системы.
   1.1. Инициализировать веб‑сервер.
   1.2. Проверить наличие файла базы данных climate_repair.db.
   1.3. При отсутствии файла базы данных вывести пользователю сообщение с указанием создать БД с помощью скрипта test.py и завершить выполнение.

2. Аутентификация пользователя.
   2.1. Отобразить форму входа с полями «Логин» и «Пароль».
   2.2. Получить от пользователя введённые значения.
   2.3. Проверить, что поля заполнены. При пустых значениях вывести предупреждение и вернуть пользователя к форме входа.
   2.4. Выполнить запрос к таблице users по логину и паролю.
   2.5. Если пользователь не найден, вывести сообщение «Неверный логин или пароль» и вернуть к шагу 2.1.
   2.6. Если у найденного пользователя признак is_active равен 0, вывести сообщение о блокировке учётной записи и завершить попытку входа.
   2.7. При успешной проверке сохранить идентификатор, ФИО и роль пользователя в сессии и перейти к просмотру списка заявок.

3. Просмотр списка заявок.
   3.1. Определить текущего пользователя по данным сессии.
   3.2. Определить роль пользователя.
   3.3. Если роль «Заказчик», выбрать из таблицы requests только те записи, где client_id совпадает с user_id пользователя.
   3.4. Если роль иная, выбрать все заявки с присоединёнными ФИО заказчика и специалиста.
   3.5. Для каждой заявки определить возможность редактирования по функции can_edit_request.
   3.6. Отобразить таблицу заявок в пользовательском интерфейсе.

4. Создание новой заявки.
   4.1. Отобразить форму создания новой заявки.
   4.2. Для заказчика автоматически установить client_id равным текущему пользователю и вывести его ФИО.
   4.3. Для менеджера и оператора загрузить список активных заказчиков и отобразить его в выпадающем списке.
   4.4. Пользователь вводит дату, тип и модель оборудования, описание проблемы и, при необходимости, выбирает исполнителя.
   4.5. Проверить заполненность обязательных полей и формат даты.
   4.6. При ошибке валидации вывести предупреждающее сообщение и вернуть к исправлению формы.
   4.7. При успешной валидации выполнить вставку новой записи в таблицу requests со статусом «Новая заявка».
   4.8. Получить сгенерированный номер заявки и вывести информационное сообщение об успешном создании.

5. Редактирование заявки.
   5.1. Пользователь выбирает заявку из списка.
   5.2. Система загружает данные заявки и определяет права доступа с помощью функции can_edit_request.
   5.3. Если редактирование запрещено, выводится сообщение об отсутствии прав и выполняется переход к списку заявок.
   5.4. В зависимости от роли:
       - заказчик может изменять только дату и описание проблемы;
       - специалист и оператор могут изменять основные поля и статус;
       - менеджер и менеджер по качеству могут изменять все поля, включая клиента.
   5.5. Проверить корректность введённых значений (обязательные поля, формат дат).
   5.6. При ошибках – вывести предупреждение и вернуть к форме редактирования.
   5.7. При корректных данных обновить запись в таблице requests; при изменении статуса автоматически добавить запись в таблицу request_history.
   5.8. Отобразить сообщение об успешном обновлении заявки.

6. Формирование статистики.
   6.1. Выполнить запрос к таблице requests для подсчёта количества заявок со статусом «Завершена».
   6.2. Выполнить запрос для расчёта среднего времени между датой начала и датой завершения по завершённым заявкам.
   6.3. Выполнить группировку заявок по типам оборудования с подсчётом количества по каждому типу.
   6.4. Передать полученные значения в шаблон статистики и отобразить их пользователю.

7. Генерация QR‑кода для отзыва.
   7.1. Получить идентификатор заявки из параметров маршрута.
   7.2. Проверить наличие заявки в базе данных.
   7.3. Сформировать URL Google‑формы для отзыва.
   7.4. Сгенерировать QR‑код на основе данного URL.
   7.5. Вернуть изображение QR‑кода в формате PNG для отображения или печати.

8. Завершение работы пользователя.
   8.1. При выборе пункта «Выход» очистить данные пользователя из сессии.
   8.2. Перенаправить пользователя на страницу входа.


2. Детализированный алгоритм расчёта статистики
-----------------------------------------------

Функция: расчёт количества выполненных заявок, среднего времени выполнения и статистики по типам оборудования.

1. Установить соединение с базой данных.
2. Выполнить SQL‑запрос:
   - выбрать количество заявок из таблицы requests, где request_status = 'Завершена';
   - сохранить результат в переменную finished_count.
3. Выполнить SQL‑запрос:
   - вычислить среднее значение разности JULIANDAY(completion_date) - JULIANDAY(start_date)
     для записей, где request_status = 'Завершена' и completion_date не пусто;
   - сохранить результат в переменную avg_days.
4. Проверить значение avg_days:
   - если avg_days не равно NULL, отформатировать значение в строку с двумя знаками после запятой;
   - если avg_days равно NULL, установить признак отсутствия данных.
5. Выполнить SQL‑запрос:
   - сгруппировать записи таблицы requests по полю climate_tech_type;
   - посчитать количество заявок для каждого типа;
   - сохранить результат в список type_rows.
6. Передать finished_count, форматированное avg_days и список type_rows в шаблон представления.
7. Отобразить:
   - количество завершённых заявок;
   - среднее время выполнения (либо сообщение об отсутствии данных);
   - таблицу количества заявок по типам оборудования.


